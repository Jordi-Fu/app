<ion-content>
  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner></ion-spinner>
    <p>Cargando perfil...</p>
  </div>

  <!-- Perfil del usuario -->
  <div *ngIf="!isLoading && userProfile" class="profile-container">
    
    <!-- Header con usuario y flecha -->
    <div class="custom-header">
      <div class="back-arrow" (click)="goBack()"></div>
      <h1 class="username-title">{{ userProfile.nombre ? getUsername() : 'Perfil' }}</h1>
    </div>

    <!-- Cabecera del perfil con avatar e info lado a lado -->
    <div class="profile-header">
      <div class="avatar-container">
        <ion-avatar class="profile-avatar">
          <img 
            [src]="getUserAvatar()" 
            [alt]="userProfile.nombre + ' ' + userProfile.apellido"
          />
        </ion-avatar>
      </div>
      
      <div class="profile-info">
        <h2 class="user-name">{{ userProfile.nombre }} {{ userProfile.apellido }}</h2>
        <p class="member-since gradient-text">Miembro en Kurro desde {{ getYear(userProfile.fecha_creacion) }}</p>
      </div>
    </div>

    <!-- Descripción -->
    <div class="descripcion-section" *ngIf="userProfile?.biografia">
      <h3 class="section-title">Descripción</h3>
      <p class="descripcion-text">
        {{ isDescripcionExpanded ? userProfile.biografia : (userProfile.biografia | slice:0:100) }}
        <span *ngIf="userProfile.biografia && userProfile.biografia.length > 100">
          <span *ngIf="!isDescripcionExpanded">...</span>
          <button class="ver-mas-btn" (click)="toggleDescripcion()">
            {{ isDescripcionExpanded ? 'Ver menos' : 'Ver más' }}
          </button>
        </span>
      </p>
    </div>

    <!-- Stats Card -->
    <div class="stats-card">
      <div class="stat-item">
        <span class="stat-value">{{ userProfile.total_servicios || 0 }}</span>
        <span class="stat-label">Servicios Activos</span>
      </div>
      <div class="stat-divider"></div>
      <div class="stat-item">
        <div class="rating-stat">
          <svg class="star-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
          </svg>
          <span class="stat-value">{{ userProfile.promedio_calificacion || 0 | number:'1.1-1' }}</span>
        </div>
        <span class="stat-label">({{ userProfile.total_resenas || 0 }} reseñas)</span>
      </div>
    </div>

    <!-- Servicios del usuario -->
    <div class="section" *ngIf="userServices && userServices.length > 0">
      <div class="section-header">
        <h2>Servicios</h2>
      </div>
      
      <div class="services-list">
        <div 
          *ngFor="let service of userServices" 
          class="service-item"
          (click)="goToService(service.id)">
          <div class="service-image">
            <img 
              [src]="service.images && service.images.length > 0 ? service.images[0].url_imagen : 'assets/placeholder-service.png'" 
              [alt]="service.titulo"
            />
          </div>
          <div class="service-details">
            <h3 class="service-title">{{ service.titulo }}</h3>
            <span class="service-price">{{ service.precio }}€/hora</span>
            <span class="service-status active">
              <ion-icon name="ellipse"></ion-icon>
              Activo
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Reseñas -->
    <div class="section">
      <div class="section-header">
        <h2>Reseñas</h2>
        <div class="sort-button" (click)="toggleSort()">
          <ion-icon name="options-outline"></ion-icon>
          <span>Ordenar</span>
        </div>
      </div>
      
      <div class="reviews-list" *ngIf="userReviews && userReviews.length > 0">
        <div *ngFor="let review of userReviews" class="review-item">
          <div class="review-header">
            <ion-avatar class="reviewer-avatar">
              <img [src]="getReviewerAvatar(review)" [alt]="review.reviewer_name" />
            </ion-avatar>
            <div class="reviewer-info">
              <span class="reviewer-name">{{ review.reviewer_name }}</span>
              <span class="reviewer-time">{{ review.reviewer_time_in_app }} en Kurro</span>
            </div>
          </div>
          <div class="review-rating">
            <div class="stars">
              <svg *ngFor="let star of getStarsArray()" 
                xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" 
                [attr.fill]="star <= review.rating ? '#ffc107' : 'none'" 
                [attr.stroke]="star <= review.rating ? '#ffc107' : '#ccc'" 
                stroke-width="2">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
              </svg>
            </div>
            <span class="review-date">Hace {{ review.time_ago }}</span>
          </div>
          <p class="review-text">{{ review.comment }}</p>
          <div class="review-service" *ngIf="review.service_name">
            <span class="review-service-label">Servicio:</span>
            <a class="review-service-link" (click)="goToService(review.service_id)">{{ review.service_name }}</a>
          </div>
        </div>
      </div>
      
      <div class="no-reviews" *ngIf="!userReviews || userReviews.length === 0">
        <p>Este usuario aún no tiene reseñas</p>
      </div>
    </div>

    <!-- Botón de contacto fijo -->
    <div class="contact-fab">
      <ion-fab-button (click)="contactUser()">
        <ion-icon name="chatbubble-outline"></ion-icon>
      </ion-fab-button>
    </div>

  </div>
</ion-content>
